@model ALODAN.Models.Usuario
@{
    ViewData["Title"] = "Proceso de Pago";
}
<div class="container mx-auto px-12">
    <h2 class="text-base font-playfair font-semibold px-4 py-2 mb-6 border-b border-gray-300 w-full"
        style="background-color:#E1DECD;">
        <a href="@Url.Action("Index", "Carrito")" class="hover:underline">Mi Carrito</a> / Proceso de Pago
    </h2>

    <!-- ✅ Mostrar mensaje de error si existe -->
    @if (TempData["ErrorCheckout"] != null)
    {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            @TempData["ErrorCheckout"]
        </div>
    }

    <div class="bg-gray-100 p-4 rounded mb-6">
        <h3 class="font-semibold mb-2">Datos del comprador</h3>
        <p><strong>Nombre:</strong> @Model.Nombre</p>
        <p><strong>Email:</strong> @Model.Email</p>
        <p><strong>Teléfono:</strong> @Model.Telefono</p>
        <p><strong>Dirección de envío:</strong> @Model.Direccion</p>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Método de pago</h3>
        <form method="post" action="@Url.Action("ConfirmarCompra", "Compras")">
            <input type="text" name="NumeroTarjeta" id="numeroTarjeta"
                   placeholder="1234 5678 9012 3456"
                   class="w-full p-2 border border-gray-300 rounded mb-3"
                   maxlength="19" required />
            <div class="flex space-x-2">
                <input type="text" name="FechaExpiracion" id="fechaExpiracion"
                       placeholder="MM/AA"
                       class="w-1/2 p-2 border border-gray-300 rounded mb-3"
                       maxlength="5" required />
                <input type="text" name="CVV" id="cvv"
                       placeholder="CVV (3 dígitos)"
                       class="w-1/2 p-2 border border-gray-300 rounded mb-3"
                       maxlength="3" required />
            </div>
            <button type="submit"
                    class="w-full bg-black text-white py-2 rounded hover:bg-gray-800">
                Confirmar pago
            </button>
        </form>
    </div>
</div>

<script nonce="@Context.Items["CspNonce"]">
    // ============================================
    // 💳 Formatear número de tarjeta (espacios cada 4 dígitos)
    // ============================================
    const inputTarjeta = document.getElementById('numeroTarjeta');

    inputTarjeta.addEventListener('input', function(e) {
        // Remover todo lo que no sea número
        let valor = e.target.value.replace(/\D/g, '');

        // Limitar a 16 dígitos
        if (valor.length > 16) {
            valor = valor.slice(0, 16);
        }

        // Formatear con espacios cada 4 dígitos
        let formateado = valor.match(/.{1,4}/g)?.join(' ') || valor;

        e.target.value = formateado;
    });

    // Prevenir que se pegue texto no numérico
    inputTarjeta.addEventListener('paste', function(e) {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData('text');
        const numeros = pasteData.replace(/\D/g, '').slice(0, 16);
        const formateado = numeros.match(/.{1,4}/g)?.join(' ') || numeros;
        e.target.value = formateado;
    });

    // ============================================
    // 📅 Formatear fecha de expiración (MM/AA)
    // ============================================
    const inputFecha = document.getElementById('fechaExpiracion');

    inputFecha.addEventListener('input', function(e) {
        let valor = e.target.value.replace(/\D/g, '');

        if (valor.length >= 2) {
            valor = valor.slice(0, 2) + '/' + valor.slice(2, 4);
        }

        e.target.value = valor;
    });

    // ============================================
    // 🔒 Solo números en CVV
    // ============================================
    const inputCVV = document.getElementById('cvv');

    inputCVV.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });
</script>