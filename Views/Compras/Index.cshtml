@model List<ALODAN.Models.Pedido>
@{
    ViewData["Title"] = "Mis Compras";
}
<div class="container mx-auto px-12">
    <h2 class="text-base font-playfair font-semibold px-4 py-2 mb-6 border-b border-gray-300 w-full"
        style="background-color:#E1DECD;">
        Mis Compras
    </h2>
    @if (!Model.Any())
    {
        <p>No tienes compras registradas.</p>
        <a href="@Url.Action("Inicio", "Productos")"
           class="mt-4 inline-block px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-700">
            Seguir comprando
        </a>
    }
    else
    {
        foreach (var pedido in Model)
        {
            // 🧮 Calcular subtotal y descuento
            decimal subtotal = pedido.Detalles.Sum(d => d.PrecioUnitario * d.Cantidad);
            decimal descuento = 0;
            string porcentajeTexto = "";

            if (subtotal >= 300)
            {
                descuento = subtotal * 0.15m;
                porcentajeTexto = "15%";
            }
            else if (subtotal >= 200)
            {
                descuento = subtotal * 0.10m;
                porcentajeTexto = "10%";
            }
            else if (subtotal >= 100)
            {
                descuento = subtotal * 0.05m;
                porcentajeTexto = "5%";
            }

            decimal totalFinal = subtotal - descuento;

            <div class="border rounded-lg p-4 mb-6 bg-gray-50 shadow-sm">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="font-semibold">Pedido N° @pedido.NumeroPedido</p>
                        <p class="text-sm text-gray-600">Fecha: @pedido.FechaPedido.ToString("dd/MM/yyyy")</p>
                    </div>
                    <div>
                        <span class="px-3 py-1 rounded text-sm font-semibold
                                            @(pedido.Estado == "Entregado" ? "bg-green-500 text-white" :
                                                                    pedido.Estado == "Listo para retiro" ? "bg-blue-400 text-white" :
                                                                    pedido.Estado == "En preparación" ? "bg-yellow-400 text-black" :
                                                                    "bg-gray-300 text-gray-800")">
                    @pedido.Estado
                </span>
            </div>
        </div>

                <table class="w-full border border-collapse text-sm">
                    <thead style="background-color:#E1DECD;">
                        <tr>
                            <th class="p-2 text-left w-2/5">Producto</th>
                            <th class="p-2 text-center w-1/12">Talla</th>
                            <th class="p-2 text-center w-1/12">Color</th>
                            <th class="p-2 text-center w-1/12">Cantidad</th>
                            <th class="p-2 text-center w-1/12">Precio</th>
                        </tr>
                    </thead>
                    <tbody>
                @foreach (var item in pedido.Detalles)
                        {
                            <tr class="border-b">
                                <td class="p-2 flex items-center">
                                    <img src="@item.Producto?.ImagenUrl" class="w-12 h-12 object-cover mr-3" />
                                    @item.Producto?.Nombre
                                </td>
                                <td class="p-2 text-center">@item.Talla</td>
                                <td class="p-2 text-center">
                                    <span class="w-6 h-6 rounded-full inline-block border"
                                          style="background-color:@item.Color"></span>
                                </td>
                                <td class="p-2 text-center">@item.Cantidad</td>
                                <td class="p-2 text-center">S/. @item.PrecioUnitario.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr style="background-color:#F5F5F5;">
                            <td colspan="4" class="p-2 text-right font-semibold">Subtotal</td>
                            <td class="p-2 text-center">S/. @subtotal.ToString("N2")</td>
                        </tr>

                        @if (descuento > 0)
                        {
                            <tr class="bg-green-50 text-green-700 font-semibold">
                                <td colspan="4" class="p-2 text-right">Descuento aplicado (@porcentajeTexto) 🎁</td>
                                <td class="p-2 text-center">-S/. @descuento.ToString("N2")</td>
                            </tr>
                        }

                        <tr class="font-bold" style="background-color:#E1DECD;">
                            <td colspan="4" class="p-2 text-right">Total pagado</td>
                            <td class="p-2 text-center">S/. @totalFinal.ToString("N2")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
    }
</div>